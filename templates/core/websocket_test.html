{% extends 'base.html' %}
{% load static %}

{% block title %}WebSocket Test - Real-Time Features{% endblock %}

{% block extra_css %}
<style>
    .websocket-test {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .test-section {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .test-section h3 {
        color: #495057;
        margin-bottom: 15px;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
    }
    
    .connection-status {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .status-indicator {
        padding: 10px 15px;
        border-radius: 5px;
        font-weight: bold;
        text-align: center;
        min-width: 120px;
    }
    
    .status-connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .control-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
    }
    
    .btn-primary {
        background: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0056b3;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn-danger:hover {
        background: #c82333;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-success:hover {
        background: #1e7e34;
    }
    
    .message-log {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        height: 400px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 14px;
    }
    
    .message-entry {
        margin-bottom: 8px;
        padding: 5px;
        border-radius: 3px;
    }
    
    .message-info {
        background: #e7f3ff;
        border-left: 3px solid #007bff;
    }
    
    .message-market {
        background: #e8f5e8;
        border-left: 3px solid #28a745;
    }
    
    .message-signal {
        background: #fff3cd;
        border-left: 3px solid #ffc107;
    }
    
    .message-notification {
        background: #f8d7da;
        border-left: 3px solid #dc3545;
    }
    
    .message-error {
        background: #f8d7da;
        border-left: 3px solid #dc3545;
        color: #721c24;
    }
    
    .live-data {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .live-data h4 {
        color: #495057;
        margin-bottom: 15px;
    }
    
    .stock-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #eee;
        background: #f8f9fa;
        margin-bottom: 5px;
        border-radius: 3px;
    }
    
    .stock-symbol {
        font-weight: bold;
        color: #495057;
    }
    
    .stock-price {
        font-size: 18px;
        font-weight: bold;
    }
    
    .stock-change {
        padding: 4px 8px;
        border-radius: 3px;
        font-weight: bold;
        font-size: 14px;
    }
    
    .change-positive {
        background: #d4edda;
        color: #155724;
    }
    
    .change-negative {
        background: #f8d7da;
        color: #721c24;
    }
    
    .stock-volume {
        color: #6c757d;
        font-size: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div class="websocket-test">
    <h1>üåê WebSocket Test - Real-Time Features</h1>
    <p class="lead">Test the real-time WebSocket functionality of your AI Trading Engine</p>
    
    <!-- Connection Status -->
    <div class="test-section">
        <h3>üîå Connection Status</h3>
        <div class="connection-status">
            <div class="status-indicator" id="market-data-status">
                Market Data: <span class="status-disconnected">Disconnected</span>
            </div>
            <div class="status-indicator" id="trading-signals-status">
                Trading Signals: <span class="status-disconnected">Disconnected</span>
            </div>
            <div class="status-indicator" id="notifications-status">
                Notifications: <span class="status-disconnected">Disconnected</span>
            </div>
        </div>
        
        <div class="control-buttons">
            <button class="btn btn-success" onclick="connectAll()">Connect All</button>
            <button class="btn btn-danger" onclick="disconnectAll()">Disconnect All</button>
            <button class="btn btn-primary" onclick="testConnections()">Test Connections</button>
        </div>
    </div>
    
    <!-- Live Market Data -->
    <div class="live-data">
        <h4>üìä Live Market Data</h4>
        <div id="live-market-data">
            <div class="stock-item" data-symbol="AAPL">
                <span class="stock-symbol">AAPL</span>
                <span class="stock-price">$150.00</span>
                <span class="stock-change change-positive">+0.00</span>
                <span class="stock-volume">Vol: 0</span>
            </div>
            <div class="stock-item" data-symbol="GOOGL">
                <span class="stock-symbol">GOOGL</span>
                <span class="stock-price">$2800.00</span>
                <span class="stock-change change-positive">+0.00</span>
                <span class="stock-volume">Vol: 0</span>
            </div>
            <div class="stock-item" data-symbol="MSFT">
                <span class="stock-symbol">MSFT</span>
                <span class="stock-price">$400.00</span>
                <span class="stock-change change-positive">+0.00</span>
                <span class="stock-volume">Vol: 0</span>
            </div>
            <div class="stock-item" data-symbol="TSLA">
                <span class="stock-symbol">TSLA</span>
                <span class="stock-price">$250.00</span>
                <span class="stock-change change-positive">+0.00</span>
                <span class="stock-volume">Vol: 0</span>
            </div>
        </div>
    </div>
    
    <!-- Message Log -->
    <div class="test-section">
        <h3>üìù Real-Time Message Log</h3>
        <div class="control-buttons">
            <button class="btn btn-primary" onclick="clearLog()">Clear Log</button>
            <button class="btn btn-success" onclick="startSimulation()">Start Live Data</button>
        </div>
        <div class="message-log" id="message-log">
            <div class="message-entry message-info">[Page Loaded] WebSocket test page ready. Click "Connect All" to start.</div>
        </div>
    </div>
</div>

<!-- Notifications Container -->
<div class="notifications-container"></div>
{% endblock %}

{% block extra_js %}
<script>
    // WebSocket connections
    let connections = {
        marketData: null,
        tradingSignals: null,
        notifications: null
    };
    
    // Stock data storage
    let stockData = {
        'AAPL': { price: 150.00, change: 0, volume: 0 },
        'GOOGL': { price: 2800.00, change: 0, volume: 0 },
        'MSFT': { price: 400.00, change: 0, volume: 0 },
        'TSLA': { price: 250.00, change: 0, volume: 0 }
    };
    
    // Add message to log
    function addMessageToLog(message, type = 'info') {
        const log = document.getElementById('message-log');
        const entry = document.createElement('div');
        entry.className = `message-entry message-${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
    }
    
    // Update stock display
    function updateStockDisplay(symbol, price, change, volume) {
        const stockItem = document.querySelector(`[data-symbol="${symbol}"]`);
        if (stockItem) {
            const priceEl = stockItem.querySelector('.stock-price');
            const changeEl = stockItem.querySelector('.stock-change');
            const volumeEl = stockItem.querySelector('.stock-volume');
            
            priceEl.textContent = `$${price.toFixed(2)}`;
            changeEl.textContent = change >= 0 ? `+${change.toFixed(2)}` : `${change.toFixed(2)}`;
            changeEl.className = `stock-change ${change >= 0 ? 'change-positive' : 'change-negative'}`;
            volumeEl.textContent = `Vol: ${volume.toLocaleString()}`;
        }
    }
    
    // Connect to WebSocket
    function connectWebSocket(type, url) {
        try {
            const ws = new WebSocket(url);
            
            ws.onopen = function(event) {
                addMessageToLog(`${type} WebSocket connected successfully!`, 'info');
                updateConnectionStatus(type, true);
                
                // Subscribe to market data
                if (type === 'marketData') {
                    ws.send(JSON.stringify({
                        type: 'subscribe_symbol',
                        symbol: 'AAPL'
                    }));
                }
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(type, data);
                } catch (e) {
                    addMessageToLog(`Error parsing message: ${e.message}`, 'error');
                }
            };
            
            ws.onclose = function(event) {
                addMessageToLog(`${type} WebSocket disconnected`, 'info');
                updateConnectionStatus(type, false);
            };
            
            ws.onerror = function(error) {
                addMessageToLog(`${type} WebSocket error: ${error}`, 'error');
                updateConnectionStatus(type, false);
            };
            
            connections[type] = ws;
            
        } catch (error) {
            addMessageToLog(`Error creating ${type} WebSocket: ${error.message}`, 'error');
        }
    }
    
    // Handle WebSocket messages
    function handleWebSocketMessage(type, data) {
        if (data.type === 'market_update') {
            addMessageToLog(`Market update: ${data.symbol} @ $${data.price} (${data.change >= 0 ? '+' : ''}${data.change})`, 'market');
            
            // Update stock display
            if (stockData[data.symbol]) {
                stockData[data.symbol] = {
                    price: data.price,
                    change: data.change,
                    volume: data.volume
                };
                updateStockDisplay(data.symbol, data.price, data.change, data.volume);
            }
        } else if (data.type === 'new_signal') {
            addMessageToLog(`New signal: ${data.signal_type} ${data.symbol}`, 'signal');
        } else if (data.type === 'notification') {
            addMessageToLog(`Notification: ${data.message}`, 'notification');
        } else {
            addMessageToLog(`Received ${type} message: ${JSON.stringify(data)}`, 'info');
        }
    }
    
    // Update connection status
    function updateConnectionStatus(type, connected) {
        const statusEl = document.getElementById(`${type}-status`);
        if (statusEl) {
            const statusSpan = statusEl.querySelector('span');
            if (connected) {
                statusSpan.textContent = 'Connected';
                statusSpan.className = 'status-connected';
            } else {
                statusSpan.textContent = 'Disconnected';
                statusSpan.className = 'status-disconnected';
            }
        }
    }
    
    // Connect all WebSockets
    function connectAll() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;
        
        connectWebSocket('marketData', `${protocol}//${host}/ws/market-data/`);
        connectWebSocket('tradingSignals', `${protocol}//${host}/ws/trading-signals/`);
        connectWebSocket('notifications', `${protocol}//${host}/ws/notifications/`);
        
        addMessageToLog('Attempting to connect to all WebSocket endpoints...', 'info');
    }
    
    // Disconnect all WebSockets
    function disconnectAll() {
        Object.keys(connections).forEach(type => {
            if (connections[type]) {
                connections[type].close();
                connections[type] = null;
            }
        });
        
        Object.keys(connections).forEach(type => {
            updateConnectionStatus(type, false);
        });
        
        addMessageToLog('All WebSocket connections closed', 'info');
    }
    
    // Test connections
    function testConnections() {
        addMessageToLog('Testing WebSocket connections...', 'info');
        
        Object.keys(connections).forEach(type => {
            if (connections[type] && connections[type].readyState === WebSocket.OPEN) {
                addMessageToLog(`${type} connection is active and working`, 'info');
            } else {
                addMessageToLog(`${type} connection is not active`, 'error');
            }
        });
    }
    
    // Clear log
    function clearLog() {
        document.getElementById('message-log').innerHTML = '';
        addMessageToLog('Log cleared', 'info');
    }
    
    // Start live data simulation
    function startSimulation() {
        addMessageToLog('Starting live data simulation...', 'info');
        
        // Simulate live updates every 2 seconds
        setInterval(() => {
            const symbols = ['AAPL', 'GOOGL', 'MSFT', 'TSLA'];
            symbols.forEach(symbol => {
                if (stockData[symbol]) {
                    const change = (Math.random() - 0.5) * 4; // -2 to +2
                    const newPrice = stockData[symbol].price + change;
                    const volume = Math.floor(Math.random() * 5000000) + 100000;
                    
                    stockData[symbol] = {
                        price: newPrice,
                        change: change,
                        volume: volume
                    };
                    
                    updateStockDisplay(symbol, newPrice, change, volume);
                    addMessageToLog(`Simulated update: ${symbol} @ $${newPrice.toFixed(2)} (${change >= 0 ? '+' : ''}${change.toFixed(2)})`, 'market');
                }
            });
        }, 2000);
        
        addMessageToLog('Live data simulation started - updates every 2 seconds', 'info');
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        addMessageToLog('WebSocket test page loaded successfully!', 'info');
        addMessageToLog('Click "Connect All" to establish WebSocket connections', 'info');
        addMessageToLog('Click "Start Live Data" to see simulated real-time updates', 'info');
    });
</script>
{% endblock %}


