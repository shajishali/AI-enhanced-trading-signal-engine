{% extends 'base.html' %}
{% load static %}

{% block title %}Real-Time Market Data - AI Trading Engine{% endblock %}

{% block extra_css %}
<style>
    .price-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        margin: 10px;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .price-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }
    
    .price-positive {
        color: #28a745;
        font-weight: bold;
    }
    
    .price-negative {
        color: #dc3545;
        font-weight: bold;
    }
    
    .price-neutral {
        color: #6c757d;
        font-weight: bold;
    }
    
    .live-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        background-color: #28a745;
        border-radius: 50%;
        margin-right: 8px;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
    }
    
    .stats-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .stats-label {
        font-size: 1.1rem;
        opacity: 0.9;
    }
    
    .connection-status {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px 15px;
        border-radius: 20px;
        font-weight: bold;
        z-index: 1000;
    }
    
    .connected {
        background-color: #28a745;
        color: white;
    }
    
    .disconnected {
        background-color: #dc3545;
        color: white;
    }
    
    .connecting {
        background-color: #ffc107;
        color: black;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status connecting">
        <span id="statusText">Connecting...</span>
    </div>
    
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-chart-line text-primary"></i>
                Real-Time Market Data Dashboard
            </h1>
            <p class="text-muted">Live cryptocurrency prices and market updates</p>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stats-card">
            <div class="stats-number" id="totalSymbols">{{ live_symbols|length }}</div>
            <div class="stats-label">Live Symbols</div>
        </div>
        <div class="stats-card">
            <div class="stats-number" id="updateCount">0</div>
            <div class="stats-label">Updates Received</div>
        </div>
        <div class="stats-card">
            <div class="stats-number" id="lastUpdate">--</div>
            <div class="stats-label">Last Update</div>
        </div>
    </div>
    
    <!-- Live Market Data -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <span class="live-indicator"></span>
                        Live Market Data
                    </h6>
                    <div class="dropdown no-arrow">
                        <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in" aria-labelledby="dropdownMenuLink">
                            <div class="dropdown-header">Actions:</div>
                            <a class="dropdown-item" href="#" onclick="refreshData()">
                                <i class="fas fa-sync-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                                Refresh Data
                            </a>
                            <a class="dropdown-item" href="#" onclick="toggleAutoRefresh()">
                                <i class="fas fa-clock fa-sm fa-fw mr-2 text-gray-400"></i>
                                <span id="autoRefreshText">Enable Auto-Refresh</span>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row" id="marketDataContainer">
                        <!-- Market data cards will be populated here -->
                        {% for symbol in live_symbols %}
                        <div class="col-lg-3 col-md-4 col-sm-6">
                            <div class="price-card" id="card-{{ symbol }}">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0 font-weight-bold">{{ symbol }}</h6>
                                    <small class="text-muted" id="time-{{ symbol }}">
                                        {% if symbol in live_data %}
                                            {{ live_data.symbol.source|default:"API" }}
                                        {% else %}
                                            --
                                        {% endif %}
                                    </small>
                                </div>
                                <div class="price-display mb-2">
                                    <span class="h5 font-weight-bold" id="price-{{ symbol }}">
                                        {% if symbol in live_data %}
                                            ${{ live_data.symbol.price|floatformat:2 }}
                                        {% else %}
                                            $--
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="change-display mb-2">
                                    <span class="h6" id="change-{{ symbol }}">
                                        {% if symbol in live_data %}
                                            {% if live_data.symbol.change >= 0 %}+{% endif %}{{ live_data.symbol.change|floatformat:2 }}%
                                        {% else %}
                                            --
                                        {% endif %}
                                    </span>
                                    <span class="h6" id="changePercent-{{ symbol }}">
                                        {% if symbol in live_data %}
                                            ({% if live_data.symbol.change_percent >= 0 %}+{% endif %}{{ live_data.symbol.change_percent|floatformat:2 }}%)
                                        {% else %}
                                            (--%)
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="volume-display">
                                    <small class="text-muted">Volume: <span id="volume-{{ symbol }}">
                                        {% if symbol in live_data %}
                                            {{ live_data.symbol.volume|floatformat:0 }}
                                        {% else %}
                                            --
                                        {% endif %}
                                    </span></small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- WebSocket Connection Info -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Connection Information</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>WebSocket Status:</strong> <span id="wsStatus">Connecting...</span></p>
                            <p><strong>Last Message:</strong> <span id="lastMessage">None</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Connection Time:</strong> <span id="connectionTime">--</span></p>
                            <p><strong>Messages Received:</strong> <span id="messageCount">0</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/websocket_client.js' %}"></script>
<script>
let updateCount = 0;
let autoRefreshEnabled = false;
let autoRefreshInterval;

// Initialize the dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeDashboard();
    setupWebSocket();
});

function initializeDashboard() {
    // Load initial data
    loadLivePrices();
    
    // Set up auto-refresh
    setupAutoRefresh();
}

function setupWebSocket() {
    // Initialize WebSocket connection
    if (typeof WebSocketClient !== 'undefined') {
        WebSocketClient.connect();
        
        // Listen for market updates
        WebSocketClient.onMessage(function(data) {
            handleMarketUpdate(data);
        });
        
        // Listen for connection status changes
        WebSocketClient.onStatusChange(function(status) {
            updateConnectionStatus(status);
        });
    } else {
        console.warn('WebSocket client not available, falling back to polling');
        // Fallback to polling if WebSocket is not available
        setInterval(loadLivePrices, 10000); // Poll every 10 seconds
    }
}

function handleMarketUpdate(data) {
    if (data.type === 'market_update') {
        updateMarketCard(data.symbol, data);
        updateCount++;
        document.getElementById('updateCount').textContent = updateCount;
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
    }
}

function updateMarketCard(symbol, data) {
    const priceElement = document.getElementById(`price-${symbol}`);
    const changeElement = document.getElementById(`change-${symbol}`);
    const changePercentElement = document.getElementById(`changePercent-${symbol}`);
    const volumeElement = document.getElementById(`volume-${symbol}`);
    const timeElement = document.getElementById(`time-${symbol}`);
    
    if (priceElement && data.price) {
        priceElement.textContent = `$${parseFloat(data.price).toFixed(2)}`;
    }
    
    if (changeElement && data.change !== undefined) {
        const change = parseFloat(data.change);
        const changePercent = parseFloat(data.change_percent || 0);
        
        changeElement.textContent = change >= 0 ? `+$${change.toFixed(2)}` : `-$${Math.abs(change).toFixed(2)}`;
        changeElement.className = change >= 0 ? 'h6 price-positive' : 'h6 price-negative';
        
        if (changePercentElement) {
            changePercentElement.textContent = `(${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%)`;
            changePercentElement.className = changePercent >= 0 ? 'h6 price-positive' : 'h6 price-negative';
        }
    }
    
    if (volumeElement && data.volume) {
        volumeElement.textContent = formatVolume(data.volume);
    }
    
    if (timeElement) {
        timeElement.textContent = new Date().toLocaleTimeString();
    }
    
    // Highlight the updated card
    const card = document.getElementById(`card-${symbol}`);
    if (card) {
        card.style.borderColor = '#28a745';
        card.style.boxShadow = '0 4px 8px rgba(40, 167, 69, 0.3)';
        
        setTimeout(() => {
            card.style.borderColor = '#e0e0e0';
            card.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
        }, 2000);
    }
}

function updateConnectionStatus(status) {
    const statusElement = document.getElementById('connectionStatus');
    const statusTextElement = document.getElementById('statusText');
    const wsStatusElement = document.getElementById('wsStatus');
    
    statusElement.className = 'connection-status ' + status;
    
    switch(status) {
        case 'connected':
            statusTextElement.textContent = 'Connected';
            wsStatusElement.textContent = 'Connected';
            break;
        case 'disconnected':
            statusTextElement.textContent = 'Disconnected';
            wsStatusElement.textContent = 'Disconnected';
            break;
        case 'connecting':
            statusTextElement.textContent = 'Connecting...';
            wsStatusElement.textContent = 'Connecting...';
            break;
    }
}

function loadLivePrices() {
    fetch('/data/api/live-prices/')
        .then(response => response.json())
        .then(data => {
            Object.keys(data.live_prices).forEach(symbol => {
                const priceData = data.live_prices[symbol];
                updateMarketCard(symbol, {
                    price: priceData.price,
                    change: priceData.change_24h,
                    change_percent: priceData.change_24h,
                    volume: priceData.volume_24h,
                    timestamp: priceData.last_updated
                });
            });
            
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        })
        .catch(error => {
            console.error('Error loading live prices:', error);
        });
}

function refreshData() {
    loadLivePrices();
}

function toggleAutoRefresh() {
    autoRefreshEnabled = !autoRefreshEnabled;
    const buttonText = document.getElementById('autoRefreshText');
    
    if (autoRefreshEnabled) {
        buttonText.textContent = 'Disable Auto-Refresh';
        autoRefreshInterval = setInterval(loadLivePrices, 5000); // Refresh every 5 seconds
    } else {
        buttonText.textContent = 'Enable Auto-Refresh';
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
    }
}

function setupAutoRefresh() {
    // Auto-refresh every 30 seconds by default
    setInterval(loadLivePrices, 30000);
}

function formatVolume(volume) {
    if (volume >= 1000000000) {
        return (volume / 1000000000).toFixed(2) + 'B';
    } else if (volume >= 1000000) {
        return (volume / 1000000).toFixed(2) + 'M';
    } else if (volume >= 1000) {
        return (volume / 1000).toFixed(2) + 'K';
    } else {
        return volume.toFixed(2);
    }
}

// Update message count and connection time
function updateConnectionInfo() {
    if (typeof WebSocketClient !== 'undefined') {
        document.getElementById('messageCount').textContent = WebSocketClient.getMessageCount() || 0;
        document.getElementById('connectionTime').textContent = WebSocketClient.getConnectionTime() || '--';
        document.getElementById('lastMessage').textContent = WebSocketClient.getLastMessage() || 'None';
    }
}

// Update connection info every second
setInterval(updateConnectionInfo, 1000);
</script>
{% endblock %}
