{% extends 'base.html' %}
{% load static %}

{% block title %}Enhanced Backtesting - AI Trading Engine{% endblock %}

{% block extra_css %}
<style>
    .search-history-card {
        max-height: 400px;
        overflow-y: auto;
    }
    .search-history-item {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .search-history-item:hover {
        background-color: #f8f9fa;
    }
    .signal-table {
        font-size: 0.9rem;
    }
    .signal-type-badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    .confidence-bar {
        height: 8px;
        border-radius: 4px;
        background-color: #e9ecef;
    }
    .confidence-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    .loading-spinner {
        display: none;
    }
    .loading-spinner.show {
        display: inline-block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-history me-2"></i>Enhanced Backtesting
                    </h1>
                    <p class="text-muted">Generate historical signals and test YOUR trading strategy on historical data.</p>
                </div>
                <div class="btn-group" role="group">
                    <a href="{% url 'analytics:dashboard' %}" class="btn btn-outline-primary">
                        <i class="fas fa-chart-line me-2"></i>Analytics Dashboard
                    </a>
                    <a href="{% url 'analytics:ml_dashboard' %}" class="btn btn-outline-success">
                        <i class="fas fa-robot me-2"></i>AI/ML Models
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Backtesting Form -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-cog me-2"></i>YOUR Strategy Backtesting Configuration</h5>
                </div>
                <div class="card-body">
                    <form id="backtestForm" method="post" action="{% url 'signals:backtest_api' %}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="generate_signals">
                        <!-- Data Availability Info -->
                        <div class="alert alert-info mb-3">
                            <h6><i class="fas fa-database me-2"></i>Historical Data Availability</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>‚úÖ Best Years for Testing:</strong>
                                    <ul class="mb-0 mt-1">
                                        <li><strong>2021:</strong> Most comprehensive data (94K+ records)</li>
                                        <li><strong>2020:</strong> Good historical data (8K+ records)</li>
                                        <li><strong>2022:</strong> Solid data coverage (6K+ records)</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <strong>‚ö†Ô∏è Limited Data Years:</strong>
                                    <ul class="mb-0 mt-1">
                                        <li><strong>2024:</strong> Very limited data (7K records)</li>
                                        <li><strong>2025:</strong> Recent data only (94K records)</li>
                                        <li><strong>2019:</strong> Minimal historical data (200 records)</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="mt-2">
                                <strong>üí° Recommendation:</strong> Use <strong>2021</strong> for comprehensive backtesting with BTC, ETH, XRP, ADA, and other major cryptocurrencies.
                            </div>
                            <div class="mt-2">
                                <strong>üéØ Signal Frequency:</strong> Your strategy guarantees <strong>minimum 1 signal per 2 months</strong> to ensure consistent backtesting opportunities.
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="symbol" class="form-label">Cryptocurrency</label>
                                <select class="form-select" id="symbol" name="symbol" required>
                                    <option value="">Loading symbols...</option>
                                </select>
                                <div class="form-text">Select a cryptocurrency for backtesting</div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="start_date" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="start_date" name="start_date" required>
                                <div class="form-text">Beginning of test period</div>
                                <div class="alert alert-info alert-sm mt-1">
                                    <small><i class="fas fa-info-circle me-1"></i><strong>Best periods:</strong> 2021 (most data), 2020, 2022</small>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="end_date" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="end_date" name="end_date" required>
                                <div class="form-text">End of test period</div>
                                <div class="alert alert-warning alert-sm mt-1">
                                    <small><i class="fas fa-exclamation-triangle me-1"></i><strong>Avoid:</strong> 2024 (limited data), future dates</small>
                                </div>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="action" class="form-label">Action</label>
                                <select class="form-select" id="action" name="action" required>
                                    <option value="generate_signals">Generate Signals</option>
                                    <option value="backtest">Run Backtest</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Additional Options -->
                        <div class="row" id="additionalOptions" style="display: none;">
                            <div class="col-md-4 mb-3">
                                <label for="strategy_name" class="form-label">Strategy</label>
                                <select class="form-select" id="strategy_name" name="strategy_name">
                                    <option value="SMA_Crossover">SMA Crossover</option>
                                    <option value="RSI_Strategy">RSI Strategy</option>
                                    <option value="MACD_Strategy">MACD Strategy</option>
                                    <option value="Bollinger_Bands">Bollinger Bands</option>
                                    <option value="Breakout_Strategy">Breakout Strategy</option>
                                    <option value="Mean_Reversion">Mean Reversion</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="initial_capital" class="form-label">Initial Capital</label>
                                <input type="number" class="form-control" id="initial_capital" name="initial_capital" value="10000" min="1000" step="1000">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="commission_rate" class="form-label">Commission Rate</label>
                                <input type="number" class="form-control" id="commission_rate" name="commission_rate" value="0.001" min="0" max="0.01" step="0.0001">
                            </div>
                        </div>
                        
                        <!-- Search Metadata -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="search_name" class="form-label">Search Name (Optional)</label>
                                <input type="text" class="form-control" id="search_name" name="search_name" placeholder="e.g., XRP Jan-Aug 2025">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="notes" class="form-label">Notes (Optional)</label>
                                <input type="text" class="form-control" id="notes" name="notes" placeholder="Add any notes about this search">
                            </div>
                        </div>
                        
                        <!-- Strategy Information Panel -->
                        <div class="alert alert-info mt-3" id="strategyInfo">
                            <h6><i class="fas fa-info-circle me-2"></i>YOUR Strategy Details:</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="list-unstyled mb-0">
                                        <li><strong>Take Profit:</strong> 15%</li>
                                        <li><strong>Stop Loss:</strong> 8%</li>
                                        <li><strong>Min Risk/Reward:</strong> 1.5:1</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <ul class="list-unstyled mb-0">
                                        <li><strong>RSI Buy Range:</strong> 20-50</li>
                                        <li><strong>RSI Sell Range:</strong> 50-80</li>
                                        <li><strong>Volume Threshold:</strong> 1.2x</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-play me-2"></i>Generate Signals Using YOUR Strategy
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="clearBtn">
                                <i class="fas fa-eraser me-2"></i>Clear Form
                            </button>
                            <button type="button" class="btn btn-outline-info" id="exportBtn" style="display: none;">
                                <i class="fas fa-download me-2"></i>Export CSV
                            </button>
                        </div>
                        
                        <!-- Loading Spinner -->
                        <div class="loading-spinner mt-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span class="ms-2">Processing your request...</span>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Search History Panel -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Searches</h5>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="refreshHistoryBtn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body search-history-card">
                    <div id="searchHistory">
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin"></i> Loading search history...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Signal Results -->
    <div class="row" id="resultsSection" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Generated Signals</h5>
                    <div>
                        <span class="badge bg-primary me-2" id="totalSignalsBadge">0 signals</span>
                        <button type="button" class="btn btn-sm btn-outline-danger" id="clearResultsBtn">
                            <i class="fas fa-trash me-1"></i>Clear Results
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Signal Summary -->
                    <div class="row mb-3" id="signalSummary">
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">Total Signals</h6>
                                    <h4 class="text-primary" id="totalSignals">0</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">Buy Signals</h6>
                                    <h4 class="text-success" id="buySignals">0</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">Sell Signals</h6>
                                    <h4 class="text-danger" id="sellSignals">0</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">Avg Confidence</h6>
                                    <h4 class="text-info" id="avgConfidence">0%</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Signal Table -->
                    <div class="table-responsive">
                        <table class="table table-hover signal-table" id="signalsTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Symbol</th>
                                    <th>Signal Type</th>
                                    <th>Strength</th>
                                    <th>Confidence</th>
                                    <th>Entry Price</th>
                                    <th>Target Price</th>
                                    <th>Stop Loss</th>
                                    <th>Risk/Reward</th>
                                    <th>Strategy Confirmations</th>
                                    <th>Signal Source</th>
                                    <th>Quality Score</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="signalsTableBody">
                                <!-- Signals will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- No Signals Message -->
                    <div class="text-center text-muted py-5" id="noSignalsMessage" style="display: none;">
                        <i class="fas fa-info-circle fa-3x mb-3 text-info"></i>
                        <h5>No signals generated for this period</h5>
                        <p class="mb-3">This is normal behavior for a quality trading strategy!</p>
                        
                        <div class="alert alert-info text-start">
                            <h6><i class="fas fa-lightbulb me-2"></i>Why no signals were generated:</h6>
                            <ul class="mb-0">
                                <li><strong>Strategy Conditions Not Met:</strong> RSI, MACD, volume, or trend conditions weren't favorable</li>
                                <li><strong>Risk/Reward Too Low:</strong> Signals must meet minimum 1.5:1 risk/reward ratio</li>
                                <li><strong>Insufficient Confirmations:</strong> Need at least 2 out of 4 strategy confirmations</li>
                                <li><strong>Market Conditions:</strong> The selected period may not have had favorable market conditions</li>
                            </ul>
                        </div>
                        
                        <div class="alert alert-success text-start">
                            <h6><i class="fas fa-check-circle me-2"></i>This means your strategy is working correctly:</h6>
                            <ul class="mb-0">
                                <li>‚úÖ <strong>Quality Control:</strong> Only generates high-quality signals</li>
                                <li>‚úÖ <strong>Risk Management:</strong> Ensures proper risk/reward ratios</li>
                                <li>‚úÖ <strong>No False Signals:</strong> Prevents signals in poor conditions</li>
                                <li>‚úÖ <strong>Professional Approach:</strong> Selective signal generation</li>
                            </ul>
                        </div>
                        
                        <p class="text-muted">
                            <strong>Try:</strong> Different date ranges, other cryptocurrencies, or check symbols that historically have more volatile periods.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Global variables
    let currentSignals = [];
    let availableSymbols = [];
    
    // Initialize the page
    initializePage();
    
    function initializePage() {
        loadSymbols();
        loadSearchHistory();
        setupEventListeners();
        setDefaultDates();
    }
    
    function loadSymbols() {
        fetch('/signals/api/backtests/search/?action=symbols')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    availableSymbols = data.symbols;
                    populateSymbolDropdown();
                } else {
                    console.error('Failed to load symbols:', data.error);
                }
            })
            .catch(error => {
                console.error('Error loading symbols:', error);
            });
    }
    
    function populateSymbolDropdown() {
        const symbolSelect = document.getElementById('symbol');
        symbolSelect.innerHTML = '<option value="">Select Cryptocurrency</option>';
        
        availableSymbols.forEach(symbol => {
            const option = document.createElement('option');
            option.value = symbol.symbol;
            option.textContent = `${symbol.symbol} - ${symbol.name}`;
            symbolSelect.appendChild(option);
        });
    }
    
    function loadSearchHistory() {
        fetch('/signals/api/backtests/search/?action=history')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displaySearchHistory(data.searches);
                } else {
                    console.error('Failed to load search history:', data.error);
                }
            })
            .catch(error => {
                console.error('Error loading search history:', error);
            });
    }
    
    function displaySearchHistory(searches) {
        const historyContainer = document.getElementById('searchHistory');
        
        if (searches.length === 0) {
            historyContainer.innerHTML = '<div class="text-center text-muted"><i class="fas fa-history fa-2x mb-2"></i><p>No recent searches</p></div>';
            return;
        }
        
        let html = '';
        searches.forEach(search => {
            html += `
                <div class="search-history-item p-2 mb-2 border rounded" onclick="loadSearchFromHistory(${search.id})">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${search.symbol}</h6>
                            <small class="text-muted">${search.start_date} to ${search.end_date}</small>
                            <br>
                            <small class="text-success">${search.signals_generated} signals</small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteSearch(${search.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    ${search.search_name ? `<small class="text-info">${search.search_name}</small>` : ''}
                </div>
            `;
        });
        
        historyContainer.innerHTML = html;
    }
    
    function setupEventListeners() {
        // Form submission
        document.getElementById('backtestForm').addEventListener('submit', handleFormSubmit);
        
        // Action change
        document.getElementById('action').addEventListener('change', handleActionChange);
        
        // Clear form
        document.getElementById('clearBtn').addEventListener('click', clearForm);
        
        // Clear results
        document.getElementById('clearResultsBtn').addEventListener('click', clearResults);
        
        // Export CSV
        document.getElementById('exportBtn').addEventListener('click', exportToCSV);
        
        // Refresh history
        document.getElementById('refreshHistoryBtn').addEventListener('click', loadSearchHistory);
    }
    
    function handleActionChange() {
        const action = document.getElementById('action').value;
        const additionalOptions = document.getElementById('additionalOptions');
        const submitBtn = document.getElementById('submitBtn');
        
        if (action === 'backtest') {
            additionalOptions.style.display = 'block';
            submitBtn.innerHTML = '<i class="fas fa-play me-2"></i>Run Backtest';
        } else {
            additionalOptions.style.display = 'none';
            submitBtn.innerHTML = '<i class="fas fa-play me-2"></i>Generate Signals';
        }
    }
    
    function handleFormSubmit(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        // Validate form
        if (!data.symbol || !data.start_date || !data.end_date) {
            alert('Please fill in all required fields');
            return;
        }
        
        // Show loading
        showLoading(true);
        
        // Make API call
        fetch('/signals/api/backtests/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            showLoading(false);
            
            if (result.success) {
                if (result.action === 'generate_signals') {
                    if (result.signals && result.signals.length > 0) {
                        displaySignals(result.signals);
                        displayStrategyInfo(result.strategy_details);
                    } else {
                        // No signals generated - show appropriate message
                        displayNoSignalsMessage(result.no_signals_reason);
                        displayStrategyInfo(result.strategy_details);
                    }
                    loadSearchHistory(); // Refresh history
                } else {
                    displayBacktestResult(result.result);
                }
            } else {
                alert('Error: ' + result.error);
            }
        })
        .catch(error => {
            showLoading(false);
            console.error('Error:', error);
            alert('An error occurred while processing your request');
        });
    }
    
    function displayStrategyInfo(strategyDetails) {
        if (!strategyDetails) return;
        
        // Create strategy info panel
        const strategyPanel = document.createElement('div');
        strategyPanel.className = 'alert alert-success mt-3';
        strategyPanel.innerHTML = `
            <h6><i class="fas fa-check-circle me-2"></i>Strategy Analysis Complete</h6>
            <p class="mb-2">Signals generated using YOUR actual trading strategy with the following parameters:</p>
            <div class="row">
                <div class="col-md-6">
                    <ul class="list-unstyled mb-0">
                        <li><strong>Take Profit:</strong> ${strategyDetails.take_profit_percentage}%</li>
                        <li><strong>Stop Loss:</strong> ${strategyDetails.stop_loss_percentage}%</li>
                        <li><strong>Min Risk/Reward:</strong> ${strategyDetails.min_risk_reward_ratio}:1</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul class="list-unstyled mb-0">
                        <li><strong>RSI Buy Range:</strong> ${strategyDetails.rsi_buy_range[0]}-${strategyDetails.rsi_buy_range[1]}</li>
                        <li><strong>RSI Sell Range:</strong> ${strategyDetails.rsi_sell_range[0]}-${strategyDetails.rsi_sell_range[1]}</li>
                        <li><strong>Volume Threshold:</strong> ${strategyDetails.volume_threshold}x</li>
                    </ul>
                </div>
            </div>
        `;
        
        // Insert after the form
        const form = document.getElementById('backtestForm');
        form.parentNode.insertBefore(strategyPanel, form.nextSibling);
    }
    
    function displaySignals(signals) {
        currentSignals = signals;
        
        if (signals.length === 0) {
            document.getElementById('noSignalsMessage').style.display = 'block';
            document.getElementById('signalsTable').style.display = 'none';
            document.getElementById('signalSummary').style.display = 'none';
            return;
        }
        
        // Show results section
        document.getElementById('resultsSection').style.display = 'block';
        document.getElementById('noSignalsMessage').style.display = 'none';
        document.getElementById('signalsTable').style.display = 'table';
        document.getElementById('signalSummary').style.display = 'flex';
        document.getElementById('exportBtn').style.display = 'inline-block';
        
        // Show success message
        showSuccessMessage(signals.length);
        
        // Update summary
        updateSignalSummary(signals);
        
        // Populate table
        populateSignalsTable(signals);
    }
    
    function displayNoSignalsMessage(noSignalsReason) {
        // Show results section but with no signals message
        document.getElementById('resultsSection').style.display = 'block';
        document.getElementById('noSignalsMessage').style.display = 'block';
        document.getElementById('signalsTable').style.display = 'none';
        document.getElementById('signalSummary').style.display = 'none';
        document.getElementById('exportBtn').style.display = 'none';
        
        // Update the no signals message with specific reason
        const noSignalsDiv = document.getElementById('noSignalsMessage');
        if (noSignalsReason) {
            // Check if it's a data availability issue
            if (noSignalsReason.includes('No historical data available')) {
                noSignalsDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
                    <h5>No Historical Data Available</h5>
                    <p class="mb-3">${noSignalsReason}</p>
                    
                    <div class="alert alert-warning text-start">
                        <h6><i class="fas fa-info-circle me-2"></i>What this means:</h6>
                        <ul class="mb-0">
                            <li><strong>Data Not Available:</strong> The selected cryptocurrency doesn't have historical data for the chosen date range</li>
                            <li><strong>Try Different Options:</strong> Select a different cryptocurrency or adjust the date range</li>
                            <li><strong>Popular Coins:</strong> BTC, ETH, XRP, ADA, SOL typically have more historical data</li>
                        </ul>
                    </div>
                    
                    <div class="alert alert-info text-start">
                        <h6><i class="fas fa-lightbulb me-2"></i>Suggestions:</h6>
                        <ul class="mb-0">
                            <li>‚úÖ Try <strong>BTC</strong> or <strong>ETH</strong> for reliable historical data</li>
                            <li>‚úÖ Use a <strong>wider date range</strong> (e.g., 6 months to 1 year)</li>
                            <li>‚úÖ Check if the cryptocurrency is actively traded</li>
                        </ul>
                    </div>
                `;
            } else {
                // Strategy-based no signals (normal behavior)
                noSignalsDiv.innerHTML = `
                    <i class="fas fa-info-circle fa-3x mb-3 text-info"></i>
                    <h5>No signals generated for this period</h5>
                    <p class="mb-3">${noSignalsReason}</p>
                    
                    <div class="alert alert-info text-start">
                        <h6><i class="fas fa-lightbulb me-2"></i>Why no signals were generated:</h6>
                        <ul class="mb-0">
                            <li><strong>Strategy Conditions Not Met:</strong> RSI, MACD, volume, or trend conditions weren't favorable</li>
                            <li><strong>Risk/Reward Too Low:</strong> Signals must meet minimum 1.5:1 risk/reward ratio</li>
                            <li><strong>Insufficient Confirmations:</strong> Need at least 2 out of 4 strategy confirmations</li>
                            <li><strong>Market Conditions:</strong> The selected period may not have had favorable market conditions</li>
                        </ul>
                    </div>
                    
                    <div class="alert alert-success text-start">
                        <h6><i class="fas fa-check-circle me-2"></i>This means your strategy is working correctly:</h6>
                        <ul class="mb-0">
                            <li>‚úÖ <strong>Quality Control:</strong> Only generates high-quality signals</li>
                            <li>‚úÖ <strong>Risk Management:</strong> Ensures proper risk/reward ratios</li>
                            <li>‚úÖ <strong>No False Signals:</strong> Prevents signals in poor conditions</li>
                            <li>‚úÖ <strong>Professional Approach:</strong> Selective signal generation</li>
                        </ul>
                    </div>
                    
                    <p class="text-muted">
                        <strong>Try:</strong> Different date ranges, other cryptocurrencies, or check symbols that historically have more volatile periods.
                    </p>
                `;
            }
        }
    }
    
    function showSuccessMessage(signalCount) {
        // Create success alert
        const successAlert = document.createElement('div');
        successAlert.className = 'alert alert-success alert-dismissible fade show';
        successAlert.innerHTML = `
            <h6><i class="fas fa-check-circle me-2"></i>Strategy Analysis Complete!</h6>
            <p class="mb-0">Successfully generated <strong>${signalCount} signals</strong> using YOUR trading strategy. 
            These signals met all your criteria: 15% TP, 8% SL, RSI ranges, MACD confirmation, and volume requirements.</p>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Insert after the form
        const form = document.getElementById('backtestForm');
        form.parentNode.insertBefore(successAlert, form.nextSibling);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (successAlert.parentNode) {
                successAlert.remove();
            }
        }, 5000);
    }
    
    function updateSignalSummary(signals) {
        const totalSignals = signals.length;
        const buySignals = signals.filter(s => s.signal_type.includes('BUY')).length;
        const sellSignals = signals.filter(s => s.signal_type.includes('SELL')).length;
        const avgConfidence = signals.reduce((sum, s) => sum + s.confidence_score, 0) / totalSignals;
        
        document.getElementById('totalSignals').textContent = totalSignals;
        document.getElementById('buySignals').textContent = buySignals;
        document.getElementById('sellSignals').textContent = sellSignals;
        document.getElementById('avgConfidence').textContent = Math.round(avgConfidence * 100) + '%';
        document.getElementById('totalSignalsBadge').textContent = totalSignals + ' signals';
    }
    
    // Helper function to format prices
    function formatPrice(price) {
        if (!price && price !== 0) return 'N/A';
        if (typeof price !== 'number' && typeof price !== 'string') return 'N/A';
        const numPrice = parseFloat(price);
        if (isNaN(numPrice) || numPrice <= 0) return 'N/A';
        return '$' + numPrice.toFixed(2);
    }
    
    function getSignalSourceBadge(source) {
        switch(source) {
            case 'NATURAL':
                return '<span class="badge bg-success">Natural</span><small class="d-block text-muted">High Quality</small>';
            case 'RELAXED_CONDITIONS':
                return '<span class="badge bg-warning">Relaxed</span><small class="d-block text-muted">Frequency Boost</small>';
            case 'TREND_FOLLOWING':
                return '<span class="badge bg-info">Trend</span><small class="d-block text-muted">Conservative</small>';
            default:
                return '<span class="badge bg-secondary">Unknown</span>';
        }
    }
    
    function populateSignalsTable(signals) {
        const tbody = document.getElementById('signalsTableBody');
        tbody.innerHTML = '';
        
        signals.forEach(signal => {
            const row = document.createElement('tr');
            
            // Determine signal type badge color
            let badgeClass = 'badge-secondary';
            if (signal.signal_type.includes('BUY')) badgeClass = 'badge-success';
            else if (signal.signal_type.includes('SELL')) badgeClass = 'badge-danger';
            
            row.innerHTML = `
                <td>${new Date(signal.created_at).toLocaleString()}</td>
                <td><strong>${signal.symbol}</strong></td>
                <td><span class="badge ${badgeClass} signal-type-badge">${signal.signal_type}</span></td>
                <td>${signal.strength}</td>
                <td>
                    <div class="confidence-bar">
                        <div class="confidence-fill bg-info" style="width: ${signal.confidence_score * 100}%"></div>
                    </div>
                    <small>${Math.round(signal.confidence_score * 100)}%</small>
                </td>
                <td>${formatPrice(signal.entry_price)}</td>
                <td>${formatPrice(signal.target_price)}</td>
                <td>${formatPrice(signal.stop_loss)}</td>
                <td>${signal.risk_reward_ratio ? signal.risk_reward_ratio.toFixed(2) : 'N/A'}</td>
                <td>
                    <span class="badge bg-info">${signal.strategy_confirmations || 0}/4</span>
                    <small class="d-block text-muted">Confirmations</small>
                </td>
                <td>
                    ${getSignalSourceBadge(signal.signal_source || 'NATURAL')}
                </td>
                <td>${signal.quality_score ? signal.quality_score.toFixed(2) : 'N/A'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewSignalDetails(${signal.id})">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    function setDefaultDates() {
        // Set default dates to 2021 where we have the most comprehensive data
        document.getElementById('start_date').value = '2021-01-01';
        document.getElementById('end_date').value = '2021-12-31';
    }
    
    function showLoading(show) {
        const spinner = document.querySelector('.loading-spinner');
        const submitBtn = document.getElementById('submitBtn');
        
        if (show) {
            spinner.classList.add('show');
            submitBtn.disabled = true;
        } else {
            spinner.classList.remove('show');
            submitBtn.disabled = false;
        }
    }
    
    function clearForm() {
        document.getElementById('backtestForm').reset();
        setDefaultDates();
        document.getElementById('additionalOptions').style.display = 'none';
    }
    
    function clearResults() {
        document.getElementById('resultsSection').style.display = 'none';
        document.getElementById('exportBtn').style.display = 'none';
        currentSignals = [];
    }
    
    function exportToCSV() {
        if (currentSignals.length === 0) {
            alert('No signals to export');
            return;
        }
        
        // Use the enhanced TradingView export API
        const exportData = {
            symbol: document.getElementById('symbol').value,
            start_date: document.getElementById('start_date').value + 'T00:00:00Z',
            end_date: document.getElementById('end_date').value + 'T23:59:59Z'
        };
        
        fetch('/signals/api/backtests/tradingview/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(exportData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Download the CSV file
                const blob = new Blob([data.csv_content], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = data.filename;
                a.click();
                window.URL.revokeObjectURL(url);
                
                // Show success message with TradingView instructions
                showTradingViewInstructions();
            } else {
                alert('Error exporting signals: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while exporting signals');
        });
    }
    
    function showTradingViewInstructions() {
        // Create modal with TradingView instructions
        const modal = document.createElement('div');
        modal.className = 'modal fade show';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-chart-line me-2"></i>TradingView Verification Guide
                        </h5>
                        <button type="button" class="btn-close" onclick="closeTradingViewModal()"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Your signals have been exported successfully! Follow these steps to verify them on TradingView:
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-step-forward me-2"></i>Quick Steps:</h6>
                                <ol>
                                    <li>Open <a href="https://tradingview.com" target="_blank">TradingView</a></li>
                                    <li>Search for your cryptocurrency (e.g., XRPUSD)</li>
                                    <li>Set the date range to match your backtest period</li>
                                    <li>Import your CSV file or manually plot signals</li>
                                    <li>Verify each signal against price action</li>
                                </ol>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-download me-2"></i>Resources:</h6>
                                <ul>
                                    <li><a href="#" onclick="downloadPineScript()">Download Pine Script Template</a></li>
                                    <li><a href="#" onclick="openVerificationGuide()">Open Verification Guide</a></li>
                                    <li><a href="#" onclick="showSignalStats()">View Signal Statistics</a></li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <h6><i class="fas fa-lightbulb me-2"></i>Verification Tips:</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>BUY signals should occur at or near local lows</li>
                                <li><i class="fas fa-check text-success me-2"></i>SELL signals should occur at or near local highs</li>
                                <li><i class="fas fa-check text-success me-2"></i>Check if signals respect key support/resistance levels</li>
                                <li><i class="fas fa-check text-success me-2"></i>Look for volume confirmation</li>
                                <li><i class="fas fa-check text-success me-2"></i>Note any signals during major news events</li>
                            </ul>
                        </div>
                        
                        <div class="mt-3">
                            <h6><i class="fas fa-chart-bar me-2"></i>Signal Statistics:</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6>Total Signals</h6>
                                            <h4 class="text-primary">${currentSignals.length}</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6>BUY Signals</h6>
                                            <h4 class="text-success">${currentSignals.filter(s => s.signal_type.includes('BUY')).length}</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6>SELL Signals</h6>
                                            <h4 class="text-danger">${currentSignals.filter(s => s.signal_type.includes('SELL')).length}</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6>Avg Confidence</h6>
                                            <h4 class="text-info">${Math.round(currentSignals.reduce((sum, s) => sum + s.confidence_score, 0) / currentSignals.length * 100)}%</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="openTradingView()">
                            <i class="fas fa-external-link-alt me-2"></i>Open TradingView
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeTradingViewModal()">
                            <i class="fas fa-times me-2"></i>Close
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Add modal backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        document.body.appendChild(backdrop);
    }
    
    window.closeTradingViewModal = function() {
        const modal = document.querySelector('.modal.show');
        const backdrop = document.querySelector('.modal-backdrop');
        if (modal) modal.remove();
        if (backdrop) backdrop.remove();
    }
    
    window.openTradingView = function() {
        window.open('https://tradingview.com', '_blank');
        window.closeTradingViewModal();
    }
    
    function downloadPineScript() {
        // Download the Pine Script template
        const pineScriptContent = `//@version=5
indicator("AI Trading Signals Verification", overlay=true)

// Replace the signal arrays below with your actual CSV data
// Format: [timestamp, price, signal_type, confidence]

// BUY Signals Data
buy_timestamps = array.from(
    timestamp("2025-01-15 10:00"),
    timestamp("2025-01-20 14:30")
)

buy_prices = array.from(0.45, 0.42)
buy_confidences = array.from(0.85, 0.72)

// SELL Signals Data  
sell_timestamps = array.from(
    timestamp("2025-01-18 16:00"),
    timestamp("2025-01-25 11:45")
)

sell_prices = array.from(0.52, 0.49)
sell_confidences = array.from(0.78, 0.83)

// Plot signals (rest of the script...)
// See TRADINGVIEW_PINE_SCRIPT_TEMPLATE.pine for complete script`;

        const blob = new Blob([pineScriptContent], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'ai_trading_signals_template.pine';
        a.click();
        window.URL.revokeObjectURL(url);
    }
    
    function openVerificationGuide() {
        window.open('/static/TRADINGVIEW_VERIFICATION_GUIDE.md', '_blank');
    }
    
    function showSignalStats() {
        const stats = {
            total: currentSignals.length,
            buy: currentSignals.filter(s => s.signal_type.includes('BUY')).length,
            sell: currentSignals.filter(s => s.signal_type.includes('SELL')).length,
            avgConfidence: Math.round(currentSignals.reduce((sum, s) => sum + s.confidence_score, 0) / currentSignals.length * 100)
        };
        
        alert(`Signal Statistics:
Total Signals: ${stats.total}
BUY Signals: ${stats.buy}
SELL Signals: ${stats.sell}
Average Confidence: ${stats.avgConfidence}%`);
    }
    
    function generateCSVContent(signals) {
        const headers = ['Timestamp', 'Symbol', 'Signal Type', 'Strength', 'Confidence', 'Entry Price', 'Target Price', 'Stop Loss', 'Risk/Reward', 'Timeframe', 'Quality Score'];
        const rows = signals.map(signal => [
            new Date(signal.created_at).toLocaleString(),
            signal.symbol,
            signal.signal_type,
            signal.strength,
            Math.round(signal.confidence_score * 100) + '%',
            signal.entry_price || 'N/A',
            signal.target_price || 'N/A',
            signal.stop_loss || 'N/A',
            signal.risk_reward_ratio ? signal.risk_reward_ratio.toFixed(2) : 'N/A',
            signal.timeframe || 'N/A',
            signal.quality_score ? signal.quality_score.toFixed(2) : 'N/A'
        ]);
        
        return [headers, ...rows].map(row => row.join(',')).join('\n');
    }
    
    // Global functions for search history
    window.loadSearchFromHistory = function(searchId) {
        // This would load a specific search from history
        console.log('Loading search:', searchId);
    };
    
    window.deleteSearch = function(searchId) {
        if (confirm('Are you sure you want to delete this search?')) {
            fetch('/signals/api/backtests/search/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ search_id: searchId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadSearchHistory();
                } else {
                    alert('Error deleting search: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the search');
            });
        }
    };
    
    window.viewSignalDetails = function(signalId) {
        // This would show detailed information about a specific signal
        console.log('Viewing signal details:', signalId);
    };
});
</script>
{% endblock %}
